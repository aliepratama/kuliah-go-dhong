<!-- Scan Modal (HTMX Target) -->
<div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4"
     x-data="{ 
         imagePreview: null, 
         scanning: false, 
         scanSuccess: false,
         useCamera: false,
         cameraStream: null,
         async startCamera() {
             try {
                 this.cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                 this.$refs.cameraVideo.srcObject = this.cameraStream;
                 this.$refs.cameraVideo.play();
             } catch(err) {
                 alert('Tidak bisa akses kamera: ' + err.message);
                 this.useCamera = false;
             }
         },
         stopCamera() {
             if (this.cameraStream) {
                 this.cameraStream.getTracks().forEach(track => track.stop());
                 this.cameraStream = null;
             }
         },
         capturePhoto() {
             const video = this.$refs.cameraVideo;
             const canvas = document.createElement('canvas');
             canvas.width = video.videoWidth;
             canvas.height = video.videoHeight;
             canvas.getContext('2d').drawImage(video, 0, 0);
             this.imagePreview = canvas.toDataURL('image/jpeg');
             this.$refs.fileInput.value = '';
             this.stopCamera();
             this.useCamera = false;
         }
     }"
     @toggle-camera.window="useCamera = !useCamera; useCamera ? startCamera() : stopCamera()"
     x-init="$watch('useCamera', value => { if(value) startCamera(); else stopCamera(); })"
     id="scan-modal">
    <div class="bg-brutal-white border-4 border-brutal-black shadow-neo-lg max-w-lg w-full max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-brutal-white border-b-3 border-brutal-black p-6 pb-3 z-10">
            <h3 class="text-xl font-sans font-black">SCAN DAUN BARU</h3>
            <p class="text-xs font-mono text-brutal-gray mt-1">ID Tanaman: {{ plant_id }}</p>
        </div>
        
        <div class="p-6 pt-4">
            <form hx-post="/api/scan-with-plant"
                  hx-encoding="multipart/form-data"
                  hx-target="#scan-result"
                  @htmx:before-send="scanning = true"
                  @htmx:after-request="scanning = false"
                  @submit="if(imagePreview && !$refs.fileInput.files.length) {
                      // Convert base64 to file for camera capture
                      fetch(imagePreview)
                          .then(res => res.blob())
                          .then(blob => {
                              const file = new File([blob], 'camera-capture.jpg', { type: 'image/jpeg' });
                              const dataTransfer = new DataTransfer();
                              dataTransfer.items.add(file);
                              $refs.fileInput.files = dataTransfer.files;
                          });
                  }"
                  class="space-y-4">
                
                <!-- Hidden plant_id -->
                <input type="hidden" name="plant_id" value="{{ plant_id }}">
                
                <!-- Mode Toggle -->
                <div class="flex gap-2 border-3 border-brutal-black p-2">
                    <button type="button"
                            @click="useCamera = false; imagePreview = null"
                            :class="!useCamera ? 'bg-brutal-white border-3 border-brutal-black' : 'bg-gray-100'"
                            class="flex-1 px-3 py-2 font-mono font-bold text-xs uppercase transition-colors">
                        <i class="ph-bold ph-upload-simple"></i> Upload
                    </button>
                    <button type="button"
                            @click="useCamera = true; imagePreview = null"
                            :class="useCamera ? 'bg-brutal-white border-3 border-brutal-black' : 'bg-gray-100'"
                            class="flex-1 px-3 py-2 font-mono font-bold text-xs uppercase transition-colors">
                        <i class="ph-bold ph-camera"></i> Camera
                    </button>
                </div>
                
                <!-- File Upload Mode -->
                <div x-show="!useCamera" class="space-y-3">
                    <input type="file" 
                           x-ref="fileInput"
                           name="file" 
                           accept="image/*" 
                           required
                           @change="imagePreview = URL.createObjectURL($event.target.files[0])"
                           class="input-brutal w-full">
                    
                    <!-- Sample Images -->
                    <div class="border-2 border-brutal-yellow bg-brutal-yellow/10 p-3">
                        <p class="font-mono font-bold text-xs mb-2">
                            <i class="ph-bold ph-images"></i> COBA GAMBAR SAMPEL:
                        </p>
                        <div class="grid grid-cols-3 gap-2">
                            <button type="button"
                                    @click="fetch('https://res.cloudinary.com/dqhuvu22u/image/upload/v1765833795/papaya/20240817_091904_i3jl3s.jpg')
                                        .then(r => r.blob())
                                        .then(blob => {
                                            const file = new File([blob], 'sample1.jpg', {type: 'image/jpeg'});
                                            const dt = new DataTransfer();
                                            dt.items.add(file);
                                            $refs.fileInput.files = dt.files;
                                            imagePreview = URL.createObjectURL(file);
                                        })"
                                    class="px-2 py-1 bg-brutal-white border-2 border-brutal-black font-mono text-xs hover:bg-brutal-yellow transition-colors">
                                Sampel 1
                            </button>
                            <button type="button"
                                    @click="fetch('https://res.cloudinary.com/dqhuvu22u/image/upload/v1765833795/papaya/20240817_091809_oiyaaz.jpg')
                                        .then(r => r.blob())
                                        .then(blob => {
                                            const file = new File([blob], 'sample2.jpg', {type: 'image/jpeg'});
                                            const dt = new DataTransfer();
                                            dt.items.add(file);
                                            $refs.fileInput.files = dt.files;
                                            imagePreview = URL.createObjectURL(file);
                                        })"
                                    class="px-2 py-1 bg-brutal-white border-2 border-brutal-black font-mono text-xs hover:bg-brutal-yellow transition-colors">
                                Sampel 2
                            </button>
                            <button type="button"
                                    @click="fetch('https://res.cloudinary.com/dqhuvu22u/image/upload/v1765840828/papaya/20240817_092129_cvftih.jpg')
                                        .then(r => r.blob())
                                        .then(blob => {
                                            const file = new File([blob], 'sample3.jpg', {type: 'image/jpeg'});
                                            const dt = new DataTransfer();
                                            dt.items.add(file);
                                            $refs.fileInput.files = dt.files;
                                            imagePreview = URL.createObjectURL(file);
                                        })"
                                    class="px-2 py-1 bg-brutal-white border-2 border-brutal-black font-mono text-xs hover:bg-brutal-yellow transition-colors">
                                Sampel 3
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Camera Mode -->
                <div x-show="useCamera" class="space-y-3">
                    <div class="border-3 border-brutal-black bg-black relative">
                        <video x-ref="cameraVideo" 
                               class="w-full h-64 object-cover"
                               autoplay 
                               playsinline></video>
                        <div class="absolute bottom-4 left-1/2 -translate-x-1/2">
                            <button type="button"
                                    @click="capturePhoto()"
                                    class="bg-brutal-green border-3 border-brutal-black text-white px-6 py-2 font-mono font-bold uppercase shadow-neo hover:bg-green-600 transition-colors flex items-center gap-2">
                                <i class="ph-bold ph-camera text-xl"></i>
                                Capture
                            </button>
                        </div>
                    </div>
                    <p class="text-xs font-mono text-brutal-gray flex items-center gap-1">
                        <i class="ph-bold ph-info"></i>
                        Posisikan daun + koin dalam frame, lalu klik Capture
                    </p>
                </div>
                
                <!-- Image Preview -->
                <div x-show="imagePreview" 
                     class="border-3 border-brutal-black p-2 bg-brutal-bg">
                    <img :src="imagePreview" 
                         alt="Preview" 
                         class="w-full h-48 object-contain">
                    <button type="button"
                            @click="imagePreview = null; $refs.fileInput.value = ''"
                            class="mt-2 w-full px-3 py-1 bg-brutal-red text-white border-2 border-brutal-black font-mono font-bold text-xs uppercase hover:bg-red-600 transition-colors">
                        <i class="ph-bold ph-x"></i> Clear
                    </button>
                </div>
                
                <!-- Loading Indicator -->
                <div x-show="scanning" 
                     class="border-3 border-brutal-yellow bg-brutal-yellow/20 p-4 text-center">
                    <i class="ph-bold ph-spinner text-4xl animate-spin inline-block"></i>
                    <p class="font-mono font-bold mt-2">PROCESSING...</p>
                </div>
                
                <!-- Result Area -->
                <div id="scan-result"></div>
                
                <!-- Buttons -->
                <div class="flex gap-3 pt-4 border-t-3 border-brutal-black">
                    <button type="button"
                            onclick="document.getElementById('modal-container').innerHTML = ''"
                            :class="scanSuccess ? 'flex-1 btn-brutal border-3 border-brutal-black' : 'flex-1 bg-gray-200 px-4 py-2 font-mono font-bold uppercase hover:bg-gray-300 transition-colors'">
                        Tutup
                    </button>
                    <button type="submit"
                            x-show="!scanSuccess"
                            :disabled="scanning"
                            class="flex-1 btn-brutal border-3 border-brutal-black disabled:opacity-50 disabled:cursor-not-allowed">
                        Scan
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.body.addEventListener('htmx:afterRequest', function(event) {
        if (event.detail.target.id === 'scan-result') {
            const response = JSON.parse(event.detail.xhr.response);
            const modal = Alpine.$data(document.getElementById('scan-modal'));
            const resultDiv = document.getElementById('scan-result');
            
            if (response.success) {
                resultDiv.innerHTML = `
                    <div class="border-3 border-brutal-green bg-brutal-green/10 p-4">
                        <p class="font-mono font-bold text-brutal-green text-lg mb-2 flex items-center gap-2">
                            <i class="ph-bold ph-check-circle"></i>
                            SCAN BERHASIL
                        </p>
                        <div class="space-y-1 text-sm font-mono">
                            <p>Luas Daun: <span class="font-bold">${response.leaf_area_cm2.toFixed(2)} cmÂ²</span></p>
                            <p class="flex items-center gap-1">
                                Koin: <span class="font-bold">${response.coin_detected ? '<i class="ph-bold ph-check text-brutal-green"></i> Terdeteksi' : '<i class="ph-bold ph-x text-brutal-red"></i> Tidak terdeteksi'}</span>
                            </p>
                        </div>
                        <img src="${response.segmented_image}" class="mt-3 w-full border-2 border-brutal-black">
                        <p class="text-xs font-mono text-brutal-gray mt-2 flex items-center gap-1">
                            <i class="ph-bold ph-info"></i>
                            Klik tombol Tutup untuk kembali ke dashboard
                        </p>
                    </div>
                `;
                if (modal) modal.scanSuccess = true;
            } else {
                resultDiv.innerHTML = `
                    <div class="border-3 border-brutal-red bg-brutal-red/10 p-4">
                        <p class="font-mono font-bold text-brutal-red flex items-center gap-2">
                            <i class="ph-bold ph-warning-circle"></i>
                            ERROR: ${response.error}
                        </p>
                    </div>
                `;
            }
        }
    });
</script>
